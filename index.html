<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>云端问卷投票系统</title>
    <!-- 引入 LeanCloud SDK -->
    <script src="//code.bdstatic.com/npm/leancloud-storage@4.12.0/dist/av-min.js"></script>
    <style>
        :root { --primary: #2d5afe; --primary-hover: #1e40cb; --success: #36d399; --danger: #ff6b6b; --bg: #f3f4f6; --card: #ffffff; --text: #333333; --border: #e5e7eb; }
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg); color: var(--text); padding-bottom: 40px; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        
        /* 组件样式 */
        .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-size: 14px; font-weight: 500; color: white; transition: 0.2s; }
        .btn-primary { background: var(--primary); }
        .btn-success { background: var(--success); }
        .btn-danger { background: var(--danger); }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
        .input { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; margin-bottom: 10px; }
        
        /* 布局细节 */
        .header { display: flex; justify-content: space-between; align-items: center; background: var(--card); padding: 15px; border-radius: 10px; margin-bottom: 20px; }
        .question-card { background: var(--card); padding: 20px; border-radius: 10px; margin-bottom: 20px; position: relative; }
        .admin-panel { background: #e0e7ff; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: none; }
        .options-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin: 15px 0; }
        .opt-btn { background: #f8f9fa; border: 1px solid var(--border); padding: 12px; border-radius: 8px; cursor: pointer; text-align: center; transition: 0.2s; }
        .opt-btn.selected { background: var(--primary); color: white; border-color: var(--primary); }
        
        /* 结果条 */
        .result-row { margin-top: 8px; font-size: 13px; }
        .progress-bg { background: #eee; height: 6px; border-radius: 3px; margin-top: 4px; overflow: hidden; }
        .progress-bar { background: var(--primary); height: 100%; width: 0; transition: width 0.5s; }

        /* 模态框 */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
        #loading-mask { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:2000; display:flex; justify-content:center; align-items:center; font-weight:bold; color: var(--primary); }
        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 20px; display: none; z-index: 2000; }
    </style>
</head>
<body>

    <!-- 加载遮罩 -->
    <div id="loading-mask">系统连接中...</div>

    <!-- 登录页 -->
    <div id="login-page" class="modal" style="display: flex; background: white;">
        <div style="text-align: center; width: 100%; max-width: 300px;">
            <h2 style="color: var(--primary); margin-bottom: 20px;">在线投票系统</h2>
            <input type="text" id="login-name" class="input" placeholder="输入您的姓名 (2-15字)" maxlength="15">
            <button onclick="handleLogin()" class="btn btn-primary" style="width: 100%;">进入系统</button>
        </div>
    </div>

    <!-- 主界面 -->
    <div class="container" id="main-app" style="display: none;">
        <div class="header">
            <div>
                <span id="user-display" style="font-weight: bold;"></span>
                <span id="role-badge" style="font-size: 12px; background: #eee; padding: 2px 6px; border-radius: 4px; margin-left: 5px;">User</span>
            </div>
            <button onclick="showAuthModal()" class="btn btn-outline" style="font-size: 12px;">权限</button>
        </div>

        <div id="admin-panel" class="admin-panel">
            <h4 style="margin-bottom: 10px;">管理员控制台 <span id="sync-status" style="font-size:12px; font-weight:normal; color:#666;">(数据自动同步)</span></h4>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button onclick="openQuestionModal()" class="btn btn-primary">新增题目</button>
                <button onclick="syncData(true)" class="btn btn-success">手动刷新数据</button>
                <button onclick="generateCloudLink()" class="btn btn-primary" style="background: #7c3aed;">复制问卷链接</button>
                <div id="link-area" style="width: 100%; display:none; margin-top:5px;">
                    <input type="text" id="share-url" class="input" readonly style="font-size:12px;">
                    <small style="color:green">请将此链接发给用户，他们才能看到这些题目。</small>
                </div>
            </div>
        </div>

        <div id="questions-container"></div>
    </div>

    <!-- 题目编辑弹窗 -->
    <div id="question-modal" class="modal">
        <div class="modal-content">
            <h3>编辑题目</h3><br>
            <input type="hidden" id="edit-id">
            <input type="text" id="q-title" class="input" placeholder="题目标题">
            <div id="opt-container"></div>
            <button onclick="addOptInput()" class="btn btn-outline" style="width:100%; margin-bottom:15px;">+ 添加选项</button>
            <div style="text-align: right; gap: 10px; display: flex; justify-content: flex-end;">
                <button onclick="closeModal('question-modal')" class="btn btn-outline">取消</button>
                <button onclick="saveQuestionToCloud()" class="btn btn-primary">保存到云端</button>
            </div>
        </div>
    </div>

    <!-- 权限弹窗 -->
    <div id="auth-modal" class="modal">
        <div class="modal-content" style="max-width: 300px;">
            <h3>管理员登录</h3><br>
            <input type="password" id="auth-pwd" class="input" placeholder="密码 (admin123)">
            <div style="text-align: right;">
                <button onclick="closeModal('auth-modal')" class="btn btn-outline">取消</button>
                <button onclick="handleAuth()" class="btn btn-primary">确认</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        // ================= 配置区域 (请修改这里) =================
        const APP_ID = 'KAyiDICFvpWjSCXaTpVvqVFs-MdYXbMMI'; 
        const APP_KEY = 'Ctugi8vi6ryC3NHKv3hjUPXf';
        const API_SERVER = 'https://avoscloud.com'; // 国际版默认节点
        // ======================================================

        let state = {
            user: '',
            role: 'user',
            quizId: null, // 云端数据库的 Object ID
            questions: [], // 题目数据
            votes: {}, // 投票数据
            tempSelections: {}
        };

        // 初始化 LeanCloud
        function initDB() {
            if(APP_ID.includes('这里填入')) {
                alert('请编辑代码，填入 LeanCloud 的 AppID 和 AppKey！');
                return;
            }
            AV.init({ appId: APP_ID, appKey: APP_KEY, serverURLs: API_SERVER });
            checkUrlForQuizId();
        }

        window.onload = function() {
            initDB();
            const savedUser = localStorage.getItem('vote_user');
            if(savedUser) {
                state.user = savedUser;
                document.getElementById('login-page').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
                document.getElementById('user-display').textContent = state.user;
                loadCloudData(); // 登录后加载数据
            } else {
                document.getElementById('loading-mask').style.display = 'none';
            }
        };

        // --- 云端数据核心逻辑 ---

        // 1. 解析 URL 获取 QuizID
        function checkUrlForQuizId() {
            const params = new URLSearchParams(window.location.search);
            state.quizId = params.get('id');
        }

        // 2. 从云端拉取数据 (读)
        async function loadCloudData() {
            document.getElementById('loading-mask').style.display = 'flex';
            try {
                if (!state.quizId) {
                    // 如果没有 ID，说明是新建模式，不做任何事，等待管理员操作
                    document.getElementById('loading-mask').style.display = 'none';
                    if(state.role === 'user') {
                        document.getElementById('questions-container').innerHTML = 
                            '<div style="text-align:center;padding:50px;color:#888">无效的问卷链接，请联系发布者。</div>';
                    }
                    return;
                }

                const query = new AV.Query('QuizTable');
                const record = await query.get(state.quizId);
                
                if (record) {
                    state.questions = record.get('questions') || [];
                    state.votes = record.get('votes') || {};
                    renderUI();
                }
            } catch (error) {
                console.error(error);
                showToast('数据加载失败: ' + error.message);
            } finally {
                document.getElementById('loading-mask').style.display = 'none';
            }
        }

        // 3. 保存题目到云端 (写)
        async function saveToCloud(showMsg = true) {
            document.getElementById('loading-mask').style.display = 'flex';
            try {
                // 创建或更新
                const QuizTable = AV.Object.extend('QuizTable');
                let quiz;
                
                if (state.quizId) {
                    quiz = AV.Object.createWithoutData('QuizTable', state.quizId);
                } else {
                    quiz = new QuizTable();
                }

                quiz.set('questions', state.questions);
                // 注意：这里不覆盖 votes，以免误删投票。投票通过单独逻辑更新
                // 但如果是新建问卷，可以初始化
                if(!state.quizId) quiz.set('votes', {}); 
                
                const saved = await quiz.save();
                state.quizId = saved.id; // 拿到 ID
                
                // 更新 URL
                const newUrl = `${window.location.pathname}?id=${state.quizId}`;
                window.history.replaceState({}, '', newUrl);
                
                if(showMsg) showToast('云端保存成功！');
                renderUI();
            } catch (error) {
                alert('保存失败: ' + error.message);
            } finally {
                document.getElementById('loading-mask').style.display = 'none';
            }
        }

        // 4. 提交投票到云端 (并发安全写)
        async function submitVoteToCloud(qid, selections) {
            document.getElementById('loading-mask').style.display = 'flex';
            try {
                // 使用 LeanCloud 原子操作或简单的拉取-修改-保存模式
                // 为了简单起见，这里使用 拉取最新 -> 修改 -> 保存 的模式
                // ⚠️ 注意：高并发下可能会有冲突，完美方案需要云函数，但纯前端使用此方案足矣
                const quiz = await new AV.Query('QuizTable').get(state.quizId);
                let currentVotes = quiz.get('votes') || {};
                
                if(!currentVotes[qid]) currentVotes[qid] = {};

                selections.forEach(opt => {
                    if(!currentVotes[qid][opt]) currentVotes[qid][opt] = [];
                    if(!currentVotes[qid][opt].includes(state.user)) {
                        currentVotes[qid][opt].push(state.user);
                    }
                });

                quiz.set('votes', currentVotes);
                await quiz.save();
                
                state.votes = currentVotes; // 更新本地视图
                showToast('投票成功！');
                delete state.tempSelections[qid];
                renderUI();

            } catch (error) {
                alert('投票失败，请重试: ' + error.message);
                loadCloudData(); // 失败后刷新数据
            } finally {
                document.getElementById('loading-mask').style.display = 'none';
            }
        }

        // --- 业务逻辑 ---

        function handleLogin() {
            const name = document.getElementById('login-name').value.trim();
            if(name.length < 2) return alert('请输入名字');
            localStorage.setItem('vote_user', name);
            state.user = name;
            location.reload();
        }

        function handleAuth() {
            const pwd = document.getElementById('auth-pwd').value;
            if(pwd === 'admin123') {
                state.role = 'admin';
                document.getElementById('admin-panel').style.display = 'block';
                document.getElementById('role-badge').textContent = 'Admin';
                document.getElementById('role-badge').style.background = '#ff6b6b';
                document.getElementById('role-badge').style.color = 'white';
                closeModal('auth-modal');
                showToast('管理员模式');
                renderUI(); // 显示编辑按钮
            } else {
                alert('密码错误');
            }
        }

        function renderUI() {
            const container = document.getElementById('questions-container');
            container.innerHTML = '';

            state.questions.forEach(q => {
                // 获取当前用户是否投过票
                const myVotes = getMyVotes(q.id);
                const hasVoted = myVotes.length > 0;

                // 构建选项 HTML
                let optsHtml = '<div class="options-grid">';
                q.options.forEach(opt => {
                    const isSelected = state.tempSelections[q.id]?.includes(opt) || myVotes.includes(opt);
                    optsHtml += `<div class="opt-btn ${isSelected ? 'selected' : ''}" 
                        onclick="toggleSelect('${q.id}', '${opt}', ${hasVoted})">${opt}</div>`;
                });
                optsHtml += '</div>';

                // 结果条 (投票后或管理员可见)
                let resultHtml = '';
                if(hasVoted || state.role === 'admin') {
                    resultHtml = '<div style="margin-top:15px; padding-top:10px; border-top:1px dashed #eee;">';
                    const qVotes = state.votes[q.id] || {};
                    // 计算总票数用来算百分比
                    let total = 0;
                    q.options.forEach(o => total += (qVotes[o]?.length || 0));

                    q.options.forEach(opt => {
                        const voters = qVotes[opt] || [];
                        const count = voters.length;
                        const pct = total > 0 ? Math.round(count/total * 100) : 0;
                        resultHtml += `
                            <div class="result-row">
                                <div style="display:flex; justify-content:space-between;">
                                    <span>${opt}</span>
                                    <span>${count}票 (${voters.join(', ')})</span>
                                </div>
                                <div class="progress-bg"><div class="progress-bar" style="width:${pct}%"></div></div>
                            </div>
                        `;
                    });
                    resultHtml += '</div>';
                }

                // 按钮
                const btn = !hasVoted 
                    ? `<button onclick="submitVote('${q.id}')" class="btn btn-primary" style="width:100%">提交投票</button>`
                    : `<button class="btn btn-success" disabled style="width:100%">已投票</button>`;

                // 删除按钮
                const delBtn = state.role === 'admin' 
                    ? `<button onclick="deleteQuestion('${q.id}')" style="position:absolute; top:15px; right:15px; font-size:12px;" class="btn btn-danger">删除</button>` 
                    : '';

                const html = `
                    <div class="question-card">
                        ${delBtn}
                        <h3>${q.title} <span style="font-size:12px; color:#888; font-weight:normal">(可多选)</span></h3>
                        ${optsHtml}
                        ${btn}
                        ${resultHtml}
                    </div>
                `;
                container.appendChild(document.createRange().createContextualFragment(html));
            });
        }

        function toggleSelect(qid, opt, locked) {
            if(locked) return;
            if(!state.tempSelections[qid]) state.tempSelections[qid] = [];
            const idx = state.tempSelections[qid].indexOf(opt);
            if(idx > -1) state.tempSelections[qid].splice(idx, 1);
            else state.tempSelections[qid].push(opt);
            renderUI();
        }

        function submitVote(qid) {
            const sels = state.tempSelections[qid];
            if(!sels || sels.length === 0) return alert('请至少选一项');
            submitVoteToCloud(qid, sels);
        }

        function getMyVotes(qid) {
            const qVotes = state.votes[qid];
            if(!qVotes) return [];
            return Object.keys(qVotes).filter(opt => qVotes[opt].includes(state.user));
        }

        // --- 管理逻辑 ---
        
        function openQuestionModal() {
            document.getElementById('q-title').value = '';
            document.getElementById('opt-container').innerHTML = '';
            addOptInput(); addOptInput();
            document.getElementById('question-modal').style.display = 'flex';
        }

        function addOptInput() {
            const div = document.createElement('div');
            div.style.marginBottom = '5px';
            div.innerHTML = `<input type="text" class="input opt-input" placeholder="选项">`;
            document.getElementById('opt-container').appendChild(div);
        }

        function saveQuestionToCloud() {
            const title = document.getElementById('q-title').value;
            const opts = Array.from(document.querySelectorAll('.opt-input')).map(i => i.value.trim()).filter(v=>v);
            if(!title || opts.length < 2) return alert('请完善题目信息');

            state.questions.push({
                id: Date.now().toString(),
                title: title,
                options: opts
            });

            saveToCloud(); // 保存整个题目数组到云端
            closeModal('question-modal');
        }

        function deleteQuestion(qid) {
            if(!confirm('确定删除？所有人的投票也会消失。')) return;
            state.questions = state.questions.filter(q => q.id !== qid);
            // 清理该题目的投票数据
            if(state.votes[qid]) delete state.votes[qid];
            saveToCloud();
        }

        function generateCloudLink() {
            if(!state.quizId) return alert('请先添加题目并保存，系统会自动生成ID');
            // 链接就是当前 URL (已经包含了 ?id=xxx)
            const url = window.location.href;
            const input = document.getElementById('share-url');
            document.getElementById('link-area').style.display = 'block';
            input.value = url;
            input.select();
            document.execCommand('copy');
            showToast('链接已复制！');
        }

        function syncData(manual) {
            loadCloudData();
            if(manual) showToast('已同步最新数据');
        }

        // 工具
        function showAuthModal() { document.getElementById('auth-modal').style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg; t.style.display = 'block';
            setTimeout(()=>t.style.display='none', 2000);
        }
    </script>
</body>
</html>
