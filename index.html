<script>
    // ==========================================
    // 【配置区】请填入你的 MemFire 信息
    // ==========================================
    const MEMFIRE_URL = 'https://d4g6fdgg91htqli3u7sg.baseapi.memfiredb.com';
    const MEMFIRE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlIjoiYW5vbiIsImV4cCI6MzM0MDUzMTM4MiwiaWF0IjoxNzYzNzMxMzgyLCJpc3MiOiJzdXBhYmFzZSJ9.fsVIuQNlARfMnBzz3GkhfnQa6nAemjRiMta_nPvNqro';
    // ==========================================

    const { createClient } = supabase;
    let db = null;
    let realtimeSub = null; // 实时订阅对象
    
    let state = {
        user: localStorage.getItem('wx_vote_user_v2') || '',
        role: 'user', 
        pageId: new URLSearchParams(location.search).get('id'),
        data: { questions: [], votes: {} },
        temp: {} 
    };

    // 初始化
    window.onload = async function() {
        if(MEMFIRE_URL.includes('这里填')) return alert('请先填入 MemFire 配置！');
        
        db = createClient(MEMFIRE_URL, MEMFIRE_KEY);
        
        if(state.user) {
            document.getElementById('login-modal').style.display = 'none';
            initApp();
        } else {
            document.getElementById('loading').style.display = 'none';
        }
    };

    function handleLogin() {
        const name = document.getElementById('username').value.trim();
        if(!name) return showToast('名字不能为空');
        state.user = name;
        localStorage.setItem('wx_vote_user_v2', name);
        location.reload();
    }

    async function initApp() {
        document.getElementById('app').style.display = 'block';
        document.getElementById('u-name').textContent = state.user;
        document.getElementById('avatar').textContent = state.user.substring(0,1).toUpperCase();
        
        if(!state.pageId) {
            document.getElementById('loading').style.display = 'none';
            if(state.role === 'user') {
                document.getElementById('quiz-list').innerHTML = `
                    <div style="text-align:center; padding:60px 20px; color:#999;">
                        <p>还没有题目哦</p>
                    </div>`;
            }
        } else {
            await loadData();
            // ★★★ 启动实时监听 ★★★
            setupRealtime(); 
        }
    }

    // --- 核心功能 ---

    async function loadData() {
        // 首次加载显示 Loading，后续更新不显示
        if(!state.data.questions.length) document.getElementById('loading').style.display = 'flex';
        
        try {
            const { data, error } = await db.from('quizzes').select('*').eq('id', state.pageId).single();
            if(data) {
                updateLocalState(data);
            }
        } catch(e) { console.error(e); } 
        finally { document.getElementById('loading').style.display = 'none'; }
    }

    // ★★★ 新增：实时监听逻辑 ★★★
    function setupRealtime() {
        if(realtimeSub) return; // 避免重复订阅

        // 监听 quizzes 表中 id 等于当前 pageId 的行
        realtimeSub = db
            .channel('any_room')
            .on('postgres_changes', { 
                event: 'UPDATE', 
                schema: 'public', 
                table: 'quizzes', 
                filter: 'id=eq.' + state.pageId 
            }, (payload) => {
                // payload.new 就是数据库里最新的一行数据
                console.log('收到实时更新:', payload);
                updateLocalState(payload.new);
                showToast('数据已实时更新 ⚡️');
            })
            .subscribe();
    }

    // 统一更新数据并渲染
    function updateLocalState(serverData) {
        state.data.questions = serverData.content || [];
        state.data.votes = serverData.votes || {};
        document.getElementById('current-id').textContent = state.pageId;
        render();
    }

    async function saveToCloud(refresh = true) {
        const title = document.getElementById('q-title').value.trim();
        const optInputs = document.querySelectorAll('.opt-input');
        const opts = Array.from(optInputs).map(i => i.value.trim()).filter(v=>v);
        
        if(!state.pageId) state.pageId = Date.now().toString();

        if(refresh) {
            if(!title || opts.length < 2) return alert('请填写完整');
            const newQ = { id: Date.now().toString(), title, options: opts };
            state.data.questions.unshift(newQ);
        }

        document.getElementById('loading').style.display = 'flex';
        
        const payload = {
            id: state.pageId,
            title: '问卷 ' + state.pageId,
            content: state.data.questions,
            votes: state.data.votes
        };

        const { error } = await db.from('quizzes').upsert(payload);
        
        document.getElementById('loading').style.display = 'none';
        if(error) {
            alert('保存失败: ' + error.message);
        } else {
            if(refresh) {
                // 如果是新建的页面，URL没有ID，此时需要刷新页面来触发 Realtime
                if(!location.search.includes('id=')) {
                    location.href = location.pathname + '?id=' + state.pageId;
                } else {
                    closeModal('edit-modal');
                    // 这里的 render 会被 Realtime 再次触发，但先本地更一下也没事
                    render();
                    showToast('发布成功！');
                }
            }
        }
    }

    async function submitVote(qid) {
        const sels = state.temp[qid];
        if(!sels || sels.length === 0) return showToast('请选择选项');

        document.getElementById('loading').style.display = 'flex';

        // 乐观更新（先不等待数据库，直接改本地，让UI变快）
        // 但为了数据一致性，这里我们采用：拉取最新 -> 合并 -> 提交
        const { data: latest } = await db.from('quizzes').select('votes').eq('id', state.pageId).single();
        let cloudVotes = latest?.votes || state.data.votes || {};

        if(!cloudVotes[qid]) cloudVotes[qid] = {};
        
        sels.forEach(opt => {
            if(!cloudVotes[qid][opt]) cloudVotes[qid][opt] = [];
            if(!cloudVotes[qid][opt].includes(state.user)) {
                cloudVotes[qid][opt].push(state.user);
            }
        });

        const { error } = await db.from('quizzes').update({ votes: cloudVotes }).eq('id', state.pageId);

        document.getElementById('loading').style.display = 'none';
        if(error) {
            alert('投票失败，请重试');
        } else {
            delete state.temp[qid];
            // 不需要手动 updateLocalState，因为 setupRealtime 会监听到这次修改并自动更新所有人
            showToast('投票成功');
        }
    }

    async function clearVotes() {
        if(!confirm('清空本页投票？')) return;
        state.data.votes = {};
        await saveToCloud(false);
    }

    // --- 渲染 (保持不变，略微优化动画) ---
    function render() {
        const container = document.getElementById('quiz-list');
        // 这里做个优化：不完全清空，尝试复用DOM（简单起见先全刷）
        const scrollPos = window.scrollY; // 记住滚动位置
        container.innerHTML = '';
        
        if(state.data.questions.length === 0) return;

        state.data.questions.forEach(q => {
            const myVotes = getMyVotes(q.id);
            const hasVoted = myVotes.length > 0;
            const isAdmin = state.role === 'admin';

            let optsHtml = '<div class="opt-grid">';
            q.options.forEach(opt => {
                const isSelected = state.temp[q.id]?.includes(opt) || myVotes.includes(opt);
                const clickAction = hasVoted ? '' : `onclick="toggleOpt('${q.id}', '${opt}')"`;
                optsHtml += `
                    <div class="opt-btn ${isSelected ? 'selected' : ''}" ${clickAction}>
                        <span>${opt}</span>
                    </div>`;
            });
            optsHtml += '</div>';

            let btnHtml = !hasVoted ? 
                `<button onclick="submitVote('${q.id}')" class="btn btn-primary">确认提交</button>` : 
                `<button class="btn btn-primary" disabled style="background:#bbf7d0; color:#166534; cursor:default;">已完成投票</button>`;

            // 管理员结果 (支持实时动画)
            let resultHtml = '';
            if(isAdmin) {
                const qVotes = state.data.votes[q.id] || {};
                let totalVotes = 0;
                Object.values(qVotes).forEach(arr => totalVotes += arr.length);

                resultHtml += `<div class="admin-result-box">`;
                q.options.forEach(opt => {
                    const voters = qVotes[opt] || [];
                    const count = voters.length;
                    const pct = totalVotes ? Math.round((count/totalVotes)*100) : 0;
                    
                    let namesHtml = voters.map(name => `<span class="voter-tag">${name}</span>`).join('');
                    if(!namesHtml) namesHtml = '<span style="font-size:12px; color:#ccc;">暂无</span>';

                    resultHtml += `
                        <div class="result-item">
                            <div class="result-header">
                                <span>${opt}</span>
                                <span>${count} 票 (${pct}%)</span>
                            </div>
                            <div class="progress-bg"><div class="progress-bar" style="width:${pct}%"></div></div>
                            <div class="voter-wall">${namesHtml}</div>
                        </div>
                    `;
                });
                resultHtml += `</div>`;
                btnHtml = `<div style="display:flex; justify-content:flex-end; margin-top:-10px; margin-bottom:10px;">
                            <button onclick="deleteQ('${q.id}')" style="font-size:12px; color:#ff4d4f; background:none; border:none;">❌ 删除</button>
                           </div>` + resultHtml; 
            }

            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <h3 style="font-size:18px; margin-bottom:5px;">${q.title}</h3>
                <div style="font-size:12px; color:#999; margin-bottom:10px;">多选模式</div>
                ${optsHtml}
                ${btnHtml}
            `;
            container.appendChild(card);
        });
        
        // 恢复滚动位置
        window.scrollTo(0, scrollPos);
    }

    // --- 辅助函数 ---
    function toggleOpt(qid, opt) {
        if(!state.temp[qid]) state.temp[qid] = [];
        const idx = state.temp[qid].indexOf(opt);
        if(idx > -1) state.temp[qid].splice(idx, 1);
        else state.temp[qid].push(opt);
        render();
    }
    function getMyVotes(qid) {
        const v = state.data.votes[qid];
        if(!v) return [];
        return Object.keys(v).filter(k => v[k].includes(state.user));
    }
    function showAuth() { document.getElementById('auth-modal').style.display = 'flex'; }
    function checkAuth() {
        if(document.getElementById('pwd').value === 'admin123') {
            state.role = 'admin';
            document.getElementById('role-tag').textContent = '管理员';
            document.getElementById('admin-box').style.display = 'block';
            closeModal('auth-modal');
            render();
        } else { showToast('密码错误'); }
    }
    function openAddModal() {
        document.getElementById('q-title').value = '';
        document.getElementById('q-opts').innerHTML = '';
        addOptLine(); addOptLine();
        document.getElementById('edit-modal').style.display = 'flex';
    }
    function addOptLine() {
        const div = document.createElement('div');
        div.innerHTML = `<input class="input opt-input" style="margin-bottom:8px; padding:10px;" placeholder="选项内容">`;
        document.getElementById('q-opts').appendChild(div);
    }
    async function deleteQ(qid) {
        if(!confirm('确定删除？')) return;
        state.data.questions = state.data.questions.filter(q => q.id !== qid);
        delete state.data.votes[qid];
        await saveToCloud(false);
    }
    function syncData(manual) { loadData(); if(manual) showToast('已同步'); }
    function copyLink() {
        const url = location.href;
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(url).then(() => showToast('链接已复制'));
        } else { prompt("请复制链接：", url); }
    }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function showToast(msg) {
        const t = document.getElementById('toast');
        t.textContent = msg; t.style.display = 'block';
        setTimeout(()=>t.style.display='none', 2000);
    }
</script>
